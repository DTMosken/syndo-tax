<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.syndo.project.zhzs.dbfxxt.mapper.ztzhfx.HysdzsglMapper">
    <!-- 行业税电指数管理 -->

    <!-- 列表 查询 -->
    <select id="selectList" resultType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl"
            parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl" databaseId="mysql">
            SELECT 
                concat(jr.`HY`,'_', FORMAT(SUM(REPLACE(jr.`sjje`,',','')) / SUM(qy.`ydl`) / 100, 10)) id,
                jr.`HY` sshy, 
                FORMAT(SUM(REPLACE(jr.`sjje`,',','')),0) sk, 
                FORMAT(SUM(qy.`ydl`),0) ydl, 
                FORMAT(SUM(REPLACE(jr.`sjje`,',','')) / SUM(qy.`ydl`) / 100, 10) sdzs
            from t_db_gdgs_qyydxx qy
            left join t_db_swj_jrkxx jr
            on jr.`NSRMC` = qy.`yhmc`
            where jr.`zsxm` = '增值税'
            <if test="skssqq != null and skssqq != ''">
                and jr.skssqq >= #{skssqq}
            </if>
            <if test="skssqz != null and skssqz != ''">
                and jr.skssqz &lt;= #{skssqz}
            </if>
            <if test="sshy != null and sshy != ''">
                AND jr.hy IN(
                    WITH recursive hy(hy_dm, hymc, sjhy_dm) AS(
                        SELECT hy_dm, hymc, sjhy_dm FROM dm_hy WHERE hymc=#{sshy}
                        UNION ALL
                        SELECT t.hy_dm, t.hymc, t.sjhy_dm FROM dm_hy t INNER JOIN hy ON t.sjhy_dm=hy.hy_dm
                    )
                    SELECT hymc FROM hy
                )
            </if>
            GROUP BY sshy
    </select>
<!-- 
    <select id="selectById" resultType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl"
            parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl">
        select jr.id, jr.`HY` sshy,jr.`SJJE` sk, qy.`ydl`,
        jr.`SJJE` / qy.`ydl` / 100 as sdzs, jr.`ZSXM`
        from t_db_gdgs_qyydl qy
        left join t_db_swj_jrkxx jr
        on jr.`NSRMC` = qy.`yhmc`
        where jr.`zsxm` = '增值税'
        and jr.id = #{id}
        and qy.id=#{ydid}
    </select> -->

    <select id="beforeSetSave" parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl" resultType="int">
        select count(1) from t_db_gdgs_hyhqyglxx where hy=#{sshy}
    </select>

    <insert id="setSave" parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl">
        <selectKey keyProperty="id" resultType="string" order="BEFORE">
            select replace(uuid(),"-","") as id
        </selectKey>
           INSERT INTO t_db_gdgs_hyhqyglxx
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">id,</if>
            <if test="sshy != null ">hy,</if>
            <if test="sdzszgz != null ">sdzszgz,</if>
            <if test="sdzszdz != null ">sdzszdz,</if>
            <if test="sdzs != null ">sdzs,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">#{id},</if>
            <if test="sshy != null ">#{sshy},</if>
            <if test="sdzszgz != null ">#{sdzszgz},</if>
            <if test="sdzszdz != null ">#{sdzszdz},</if>
            <if test="sdzs != null ">#{sdzs},</if>
        </trim>
    </insert>
    <update id="setSaveUpdate" parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Hysdzsgl">
        update t_db_gdgs_hyhqyglxx set hy=#{sshy}, sdzszgz=#{sdzszgz}, sdzszdz=#{sdzszdz}, sdzs=#{sdzs}
        where hy=#{sshy}
    </update>
</mapper>