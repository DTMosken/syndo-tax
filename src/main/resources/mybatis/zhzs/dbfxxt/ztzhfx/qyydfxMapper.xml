<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.syndo.project.zhzs.dbfxxt.mapper.ztzhfx.QyydfxMapper">
    <!-- 企业用电分析 -->

    <!-- 列表 查询 -->
    <select id="selectList" resultType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Qyydfx"
            parameterType="com.syndo.project.zhzs.dbfxxt.domain.ztzhfx.Qyydfx">
        select 
            a.NSRSBH tyshxydm,
            a.NSRMC, 
            a.SKSSQQ ssqq, 
            a.skssqz ssqz, 
            a.sjje zzs, 
            a.ydl, 
            format(a.sdzs, 10) sdzs,
            concat(concat(h.`sdzszdz`,'-'), h.`sdzszgz`) as hysdzsfw, 
            format(a.sdzs - h.sdzs, 10) as sdzscy
        from (
        select jr.`NSRSBH` NSRSBH, jr.`NSRMC` NSRMC, jr.`SKSSQQ` SKSSQQ, jr.`hy` hy,
        jr.`SKSSQZ` SKSSQZ, jr.`SJJE` SJJE,qy.`ydl` ydl, jr.`SJJE` / qy.`ydl` / 100 sdzs
        from t_db_gdgs_qyydxx qy left join t_db_swj_jrkxx jr
        on qy.`yhmc` = jr.`NSRMC`
        where jr.`zsxm` = '增值税'
        ) a left join t_db_gdgs_hyhqyglxx h on a.hy = h.`hy`
        where 1 = 1
        <if test="ssqq != null and ssqq != ''">
            and a.skssqq >= #{ssqq}
        </if>
        <if test="ssqz != null and ssqz != ''">
            and a.skssqz &lt;= #{ssqz}
        </if>
        <if test="sshy != null and sshy != ''">
            AND a.hy IN(
                WITH recursive hy(hy_dm, hymc, sjhy_dm) AS(
                    SELECT hy_dm, hymc, sjhy_dm FROM dm_hy WHERE hymc=#{sshy}
                    UNION ALL
                    SELECT t.hy_dm, t.hymc, t.sjhy_dm FROM dm_hy t INNER JOIN hy ON t.sjhy_dm=hy.hy_dm
                )
                SELECT hymc FROM hy
            )
        </if>
        <if test="nsrmc != null and nsrmc != ''">
            and a.nsrmc like concat(concat('%',#{nsrmc}),'%')
        </if>
    </select>
</mapper>