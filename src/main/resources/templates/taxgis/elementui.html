<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<!-- elementui table控件 -->
<div th:fragment="table">
    <style>
        /* 表格 */
        /*.el-pagination-pages {
            font-weight: normal;
            color: white;
        }

        .el-pagination__total {
            color: white;
        }

        .el-pagination.is-background .btn-prev,
        .el-pagination.is-background .btn-next {
            background-color: rgba(244, 244, 245, 0.5);
        }*/

        .el-pagination__editor .el-input-number {
            padding: 0;
            width: 66px;
            line-height: 28px;
        }

        .el-pagination__editor.el-input {
            width: 66px;
        }

        .el-input-number.is-without-controls .el-input .el-input__inner {
            width: 66px;
            padding: 0;
            /*color: white;
            background-color: rgba(255, 255, 255, 0.3);
            border: 0;*/
        }

        /*.el-table .cell {
            line-height: 15px;
        }*/

        /*.el-table--border {
            border-color: rgba(235, 238, 245, 0.2);
        }*/

        .el-table th,
        .el-table tr,
        .el-table td,
        .el-table th.is-leaf {
            /*color: #e5dada;
            border-color: rgba(235, 238, 245, 0.2);
            background-color: transparent !important;*/
            /*line-height: 20px;*/
            background-color: transparent;
            padding: 5px 0;
        }

        /*.el-table th.is-leaf {
            padding: 11px 0;
        }*/

        .el-table__body tr.current-row > td {
            /*background-color: rgba(236, 245, 255, 0.2) !important;*/
            background-color: transparent;
        }

        .el-table__body tr:hover > td {
            /*background-color: rgba(236, 245, 255, 0.1) !important;*/
            background-color: transparent;
        }

        .el-table--border::after,
        .el-table--group::after,
        .el-table::before {
            background-color: transparent;
        }

        .myElTable {
            position: absolute;
            width: 100%;
            height: calc(100% - 102px);
        }

        .cell.cellStyle {
            /* background-color: #f2f2f2; */
            white-space: nowrap;
        }

        /* 修改边框颜色 */
        .el-table--border,
        .el-table--group {
            /* border: 1px solid #ebeef5; */
            border: 1px solid #ddd;
        }

        .el-table--border td,
        .el-table--border th,
        .el-table__body-wrapper .el-table--border.is-scrolling-left ~ .el-table__fixed {
            /* border-right: 1px solid #ebeef5; */
            border-right: 1px solid #ddd;
        }

        .el-table td,
        .el-table th.is-leaf {
            /* border-bottom: 1px solid #ebeef5; */
            border-bottom: 1px solid #ddd;
        }

        /*.el-button {
            color: white;
            border-color: rgba(235, 238, 245, 0.2);
            background-color: rgba(255, 255, 255, 0.3);
        }

        .el-button:focus,
        .el-button:hover {
            color: #409eff;
            border-color: rgba(235, 238, 245, 0.2);
            background-color: rgba(48, 49, 51, 0.7);
        }*/
    </style>
    <template id="paggerTemplate">
        <div class="pagination">
            <el-pagination
                background
                @current-change="handleCurrentChange"
                :current-page.sync="currentPage"
                :page-size.sync="pageSize"
                :pager-count="5"
                layout="prev, slot, next, ->, total"
                :total="total"
            >
                <template v-if="pageCount > 0">
                    <span class="el-pagination-pages" style="display: inline; color: #606266; font-weight: 400">第</span>
                    <div class="el-input el-pagination__editor is-in-pagination">
                        <el-input-number
                            v-model="currentPage"
                            :value="currentPage"
                            @change="handleCurrentChange"
                            :min="1"
                            :max="pageCount"
                            :controls="false"
                        ></el-input-number>
                    </div>
                    <span class="el-pagination-pages" style="color: #606266; font-weight: 400">/ {{ pageCount }} 页</span>
                </template>
                <template v-else>
                    <span class="el-pagination-pages" style="display: inline; color: #606266; font-weight: 400">第</span>
                    <div class="el-input el-pagination__editor is-in-pagination">
                        <el-input-number :value="0" :min="0" :max="0" :controls="false"></el-input-number>
                    </div>
                    <span class="el-pagination-pages" style="color: #606266; font-weight: 400">/ 0 页</span>
                </template>
            </el-pagination>
        </div>
    </template>
    <script type="module">
        Vue.component('pagger', {
            template: '#paggerTemplate',
            props: {
                total: {
                    required: true,
                    type: Number
                },
                page: {
                    type: Number,
                    default: 1
                },
                limit: {
                    type: Number,
                    default: 10 // 每页的数据条数
                }
            },
            computed: {
                currentPage: {
                    get() {
                        return this.page
                    },
                    set(val) {
                        this.$emit('update:page', val)
                    }
                },
                pageSize: {
                    get() {
                        return this.limit
                    },
                    set(val) {
                        this.$emit('update:limit', val)
                    }
                },
                pageCount: {
                    get() {
                        return Math.ceil(this.total / this.limit)
                    }
                }
            },
            methods: {
                //每页条数改变时触发 选择一页显示多少行
                handleSizeChange(val) {
                    this.currentPage = 1
                    this.pageSize = val
                },
                //当前页改变时触发 跳转其他页
                handleCurrentChange(val) {
                    this.currentPage = val
                    this.loadData(val)
                },
                loadData(num1) {
                    this.$emit('load-data', { pagination: { currentPage: num1, pageSize: this.pageSize } })
                }
            }
        })
    </script>
    <template id="myElTableTemplate">
        <div :class="tableClass">
            <el-table
                v-loading="loading"
                ref="myElTable"
                :data="tableData"
                :height="height"
                style="background-color: transparent"
                header-cell-style="background-color: #f2f2f2; color:#676a6c"
                @row-click="rowClick"
                border
                highlight-current-row
            >
                <el-table-column type="selection" :selectable="isSelectable" width="40" align="center"> </el-table-column>
                <slot name="left"></slot>
                <el-table-column
                    v-for="item in columns"
                    :key="item.prop"
                    v-if="item.show"
                    :prop="item.prop"
                    :label="item.label"
                    :width="item.width"
                    :formatter="item.format"
                    label-class-name="cellStyle"                    
                    show-overflow-tooltip
                    :align="item.align"
                >
                </el-table-column>
                <slot></slot>
            </el-table>
            <pagger v-if="isPage"
                @load-data="loadData"
                :page.sync="pagination.currentPage"
                :limit.sync="pagination.pageSize"
                :total="pagination.totalRows"
            ></pagger>
        </div>
    </template>
    <script type="module">
        // import qs from "../js/qs.js";
        Vue.component('myElTable', {
            template: '#myElTableTemplate',
            props: {
                isPage: {
                    type: Boolean,
                    default: true
                },
                tableClass: {
                    type: String,
                    default: 'myElTable'
                },
                dataUrl: {
                    required: true,
                    type: String
                },
                queryParams: {
                    type: Object,
                    default: {}
                },
                multiSelect: {
                    type: Boolean,
                    default: false
                },
                columns: {
                    required: true,
                    type: Array
                },
                paggerUrlType: {
                    type: String,
                    default: 'startPage' // pageTable
                }
            },
            data() {
                return {
                    loading: false,
                    height: this.isPage ? "calc(100% - 32px)" : "100%",
                    tableData: [],
                    headerCellStyle: {
                        'white-space': 'nowrap'
                    },
                    pagination: {
                        totalRows: 0, //总条数
                        pageSize: 20, //每页显示条数
                        currentPage: 1
                    }
                }
            },
            mounted() {
                for (let i = 0; i < this.columns.length; i++) {
                    this.columns[i] = $.extend({ show: true, align: 'center' }, this.columns[i])
                }
            },
            methods: {
                isSelectable(row, index) {
                    if (this.multiSelect) {
                        return true
                    } else {
                        // 只能选中一行
                        return this.$refs.myElTable.selection.length === 0 || this.$refs.myElTable.selection[0] === row
                    }
                },
                rowClick(row) {
                    if (this.$refs.myElTable.selection[0] !== row && !this.multiSelect) {
                        this.$refs.myElTable.clearSelection()
                    }
                    this.$refs.myElTable.toggleRowSelection(row)
                    this.$emit('row-click', row)
                },
                getSelected() {
                    return this.$refs.myElTable.selection
                },
                loadData() {
                    this.loading = true
                    // let that = this;
                    let gotoPage = this.pagination.currentPage
                    let params = {}
                    if (this.paggerUrlType === 'startPage') {
                        $.extend(params, this.queryParams, { pageNum: gotoPage, pageSize: this.pagination.pageSize })
                    } else if (this.paggerUrlType === 'pageTable') {
                        $.extend(params, this.queryParams, { page: gotoPage, limit: this.pagination.pageSize })
                    } else {
                        $.extend(params, this.queryParams, { pageNum: gotoPage, pageSize: this.pagination.pageSize })
                    }
                    this.axios
                        .post(this.dataUrl, Qs.stringify(params))
                        .then((response) => {
                            // 请求成功
                            if (this.paggerUrlType === 'startPage') {
                                this.tableData = response.data.rows
                                this.pagination.totalRows = response.data.total
                            } else if (this.paggerUrlType === 'pageTable') {
                                this.tableData = response.data.data
                                this.pagination.totalRows = response.data.count
                            } else {
                                this.tableData = response.data.rows
                                this.pagination.totalRows = response.data.total
                            }
                            this.loading = false
                            this.$emit('on-load', response.data)
                        })
                        .catch((error) => {
                            // 请求失败
                            this.loading = false
                            console.log('请求失败')
                            console.log(error)
                        })
                },
                queryList() {
                    this.pagination.currentPage = 1
                    this.loadData()
                }
            }
        })
    </script>


<template id="myElTable2Template">
    <div :class="tableClass">
        <el-table
            v-loading="loading"
            ref="myElTable"
            :data="tableData"
            height="calc(100% - 32px)"
            style="background-color: transparent"
            header-cell-style="background-color: #f2f2f2; color:#676a6c"
            @row-click="rowClick"
            border
            highlight-current-row
        >
            <el-table-column type="selection" :selectable="isSelectable" width="40" align="center"> </el-table-column>
            <slot></slot>
        </el-table>
        <pagger
            @load-data="loadData"
            :page.sync="pagination.currentPage"
            :limit.sync="pagination.pageSize"
            :total="pagination.totalRows"
        ></pagger>
    </div>
</template>
<script type="module">
    // import qs from "../js/qs.js";
    Vue.component('myElTable2', {
        template: '#myElTable2Template',
        props: {
            tableClass: {
                type: String,
                default: 'myElTable'
            },
            dataUrl: {
                required: true,
                type: String
            },
            queryParams: {
                type: Object,
                default: {}
            },
            multiSelect: {
                type: Boolean,
                default: false
            }
        },
        data() {
            return {
                loading: false,
                tableData: [],
                headerCellStyle: {
                    'white-space': 'nowrap'
                },
                pagination: {
                    totalRows: 0, //总条数
                    pageSize: 20, //每页显示条数
                    currentPage: 1
                }
            }
        },
        methods: {
            isSelectable(row, index) {
                if (this.multiSelect) {
                    return true
                } else {
                    // 只能选中一行
                    return this.$refs.myElTable.selection.length === 0 || this.$refs.myElTable.selection[0] === row
                }
            },
            rowClick(row) {
                if (this.$refs.myElTable.selection[0] !== row && !this.multiSelect) {
                    this.$refs.myElTable.clearSelection()
                }
                this.$refs.myElTable.toggleRowSelection(row)
                this.$emit('row-click', row)
            },
            getSelected() {
                return this.$refs.myElTable.selection
            },
            loadData() {
                this.loading = true
                // let that = this;
                let gotoPage = this.pagination.currentPage
                let params = {}
                $.extend(params, this.queryParams, { pageNum: gotoPage, pageSize: this.pagination.pageSize })
                this.axios
                    .post(this.dataUrl, Qs.stringify(params))
                    .then((response) => {
                        // 请求成功
                        this.tableData = response.data.rows
                        this.pagination.totalRows = response.data.total
                        this.loading = false
                        this.$emit('on-load', response.data)
                    })
                    .catch((error) => {
                        // 请求失败
                        this.loading = false
                        console.log('请求失败')
                        console.log(error)
                    })
            },
            queryList() {
                this.pagination.currentPage = 1
                this.loadData()
            }
        }
    })
</script>


    <style>
        .myPanel {
            position: absolute;
            top: 0;
            height: 100%;
            /*border: 2px solid rgba(204, 204, 204, 0.3);*/
            /*border-radius: 5px;*/
            /*background-color: rgba(48, 49, 51, 0.7);*/
            /*background-color: rgba(47, 64, 80, 0.7);*/
            /*background-color: rgba(255, 255, 255, 0.8);*/
            /*background-color: white;*/
            background-color: transparent;
            pointer-events: none;
            overflow: hidden;
            z-index: 1000;
        }

        .myPanelInner {
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 18px);
            height: 100%;
            /*border: 2px solid rgba(204, 204, 204, 0.3);*/
            /*border: 1px solid #aaa;*/
            /*border-radius: 5px;*/
            background-color: white;
            transition: left 0.5s ease;
            pointer-events: auto;
        }

        .mypanelResizer {
            position: absolute;
            width: 3px;
            height: 100%;
            top: 0;
            right: 15px;
            background-color: white;
            pointer-events: auto;
            border: none;
            border-right: 1px solid #aaa;
            box-shadow: 1px 0 5px rgba(0, 0, 0, 0.5);
            cursor: w-resize;
            z-index: 100;
        }

        .side_bar_stretch {
            position: absolute;
            width: 15px;
            height: 30px;
            background: hsla(0, 0%, 100%, 0.5);
            top: 46%;
            right: 0;
            border: 1px solid #aaa;
            border-radius: 0 15px 15px 0;
            border-left: none;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.5) inset;
            cursor: pointer;
            display: block;
            transition: 0.2s;
            border-collapse: separate;
            pointer-events: auto;
        }

        .side_to_left {
            background-position: -217px -216px;
        }

        .side_to_right {
            background-position: -232px -216px;
        }

        .side_to_left,
        .side_to_right {
            background-image: url('/img/icons/icon.tdt.png');
            width: 5px;
            height: 9px;
            display: block;
            margin-top: 10px;
            margin-left: 4px;
        }
    </style>
    <template id="myPanelTemplate">
        <div class="myPanel" :style="panelStyle">
            <a :title="this.collapsed?'显示列表':'隐藏列表'" href="javascript:;" @click="toggleShow" class="side_bar_stretch"
                ><span :class="this.collapsed?'side_to_right':'side_to_left'"></span
            ></a>
            <div class="mypanelResizer" @mousedown="mouseDown"></div>
            <div class="myPanelInner">
                <slot></slot>
            </div>
        </div>
    </template>
    <script type="module">
        Vue.component('myPanel', {
            template: '#myPanelTemplate',
            props: {
                collapsed: {
                    type: Boolean,
                    default: false
                },
                width: {
                    type: Number,
                    default: 340
                },
                height: {
                    type: String,
                    default: '100%'
                }
            },
            data() {
                return {
                    isDown: false,
                    panelStyle: {
                        left: this.getLeft(),
                        width: this.getWidth(),
                        height: this.height
                    }
                }
            },
            watch: {
                width(newV, oldV) {
                    this.panelStyle.width = newV + 15 + 'px';
                    this.$emit('update:width', newV);
                },
                height(newV, oldV) {
                    this.panelStyle.height = newV;
                    this.$emit('update:height', newV);
                }
            },
            created() {
                document.addEventListener('mouseup', this.mouseUp)
            },

            destroyed() {
                document.removeEventListener('mouseup', this.mouseUp)
            },
            methods: {
                getWidth() {
                    return this.width + 15 + 'px'
                },
                getLeft() {
                    return this.collapsed ? this.width * -1 + 'px' : '0'
                },
                showPanel() {
                    this.collapsed = false
                    this.panelStyle.left = this.getLeft()
                },
                hidePanel() {
                    this.collapsed = true
                    this.panelStyle.left = this.getLeft()
                },
                toggleShow() {
                    this.collapsed = !this.collapsed
                    this.panelStyle.left = this.getLeft()
                },
                mouseDown(event) {
                    this.isDown = true
                    document.addEventListener('mousemove', this.mouseMove)
                    this.lastX = event.screenX
                },
                mouseMove(event) {
                    if (this.isDown) {
                        // this.$emit("widthChange", this.lastX - event.screenX);
                        this.widthChange(this.lastX - event.screenX)
                        this.lastX = event.screenX
                        window.getSelection ? window.getSelection().removeAllRanges() : document.selection.empty();
                    }
                },
                mouseUp() {
                    this.isDown = false
                    this.lastX = ''
                    document.body.style.pointerEvents = 'auto';
                    document.removeEventListener('mousemove', this.mouseMove)
                },
                widthChange(movement) {
                    this.width -= movement
                    if (this.width < 200) {
                        this.width = 200
                    }
                    if (this.width > 700) {
                        this.width = 700
                    }
                    this.panelStyle.width = this.getWidth()
                }
            }
        })
    </script>
</div>
