<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('添加风控小组成员')"/>
</head>
<body>
<div class="main-content">
    <form id="form-user-add" class="form-horizontal">
        <input name="dept" type="hidden" id="treeId"/>
        <input name="fzid" type="hidden" id="fzid">
        <input name="userId" type="hidden" id="userId"/>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label is-required">登录名称：</label>
                    <div class="col-sm-4">
                        <input id="userName" name="userName" autocomplete="off" placeholder="请输入用户名称" class="form-control" type="text"
                               maxlength="30" required>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-sm btn-success" onclick="selectUser()">
                            <i class="fa fa-search"></i>选择系统用户
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">姓名：</label>
                    <div class="col-sm-8">
                        <input id="name" name="name" autocomplete="off" placeholder="请输入姓名" class="form-control" type="text"
                               maxlength="50" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">性别：</label>
                    <div class="col-sm-8">
                        <select id="sex" name="sex" class="form-control" th:with="type=${@dict.getType('sys_user_sex')}">
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}"></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">年龄：</label>
                    <div class="col-sm-8">
                        <input id="age" name="age" autocomplete="off" placeholder="请输入年龄" class="form-control" type="number"
                               maxlength="3">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">联系方式：</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input id="phone" name="phone" placeholder="请输入电话号码" class="form-control" type="text"
                                   maxlength="11">
                            <span class="input-group-addon"><i class="fa fa-mobile"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">部门：</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input th:id="deptName" name="deptName" onclick="selectDeptTree()" id="treeName" type="text" placeholder="请选择部门"
                                   class="form-control" required>
                            <span class="input-group-addon"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">状态：</label>
                    <div class="col-sm-8">
                        <select id="status" name="status" class="form-control">
                            <option value="0">作为反馈人</option>
                            <option value="1">不作为反馈人</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">角色：</label>
                    <div class="col-sm-8">
                        <select id="role" name="role" class="form-control">
                            <option value="0">组员</option>
                            <option value="1">组长</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">分组：</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input name="fzmc" onclick="selectFzTree()" id="fzmc" type="text" placeholder="请选择分组"
                                   class="form-control" required>
                            <span class="input-group-addon"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-xs-2 control-label">特长：</label>
                    <div class="col-xs-10">
                        <textarea id="speciality" name="speciality" autocomplete="off" maxlength="500" class="form-control"
                                  rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<th:block th:include="include :: footer"/>
<script>
    var prefix = ctx + "zhzs/dbfxxt/ts/fkxz";

    $("#form-user-add").validate({
        onkeyup: false,
        rules: {
            loginName: {
                required: true,
            },
            name: {
                required: true,
            },
            deptName: {
                required: true,
            },
            status: {
                required: true,
            },
            role: {
                required: true,
            },
            fzmc: {
                required: true,
            },
        },
        messages: {
        },
        focusCleanup: true
    });

    function submitHandler() {
        if ($.validate.form()) {
            var data = $("#form-user-add").serializeArray();
            // var status = $("input[id='status']").is(':checked') == true ? 0 : 1;
            // var roleIds = $.form.selectSelects("role");
            // var postIds = $.form.selectSelects("post");
            // data.push({"name": "status", "value": status});
            // data.push({"name": "roleIds", "value": roleIds});
            // data.push({"name": "postIds", "value": postIds});
            $.operate.save(prefix + "/add", data);
        }
    }

    /* 选择用户 */
    function selectUser() {
        var url = prefix + "/selectUser";
        parent.$.modal.open("选择用户", url, null, null, function(index, layero){
            var $table = layero.find("iframe")[0].contentWindow.$.table;
            var rows = $table.selectFirstColumns();
            if (rows.length != 1) {
                parent.$.modal.alertWarning("请选择一条记录");
                return;
            }
            parent.layer.close(index);
            $.post(prefix+'/selectUserById/'+rows[0], function (response){
                if(response.code == 0){
                    var data = response.data;
                    // console.log(data)
                    $('#userId').val(data.userId);
                    $('#name').val(data.userName);
                    $('#userName').val(data.loginName);
                    $('#sex').val(data.sex);
                    $('#phone').val(data.phonenumber);
                    $('#deptName').val(data.dept.deptName);
                    $('#treeId').val(data.dept.deptId);
                    // console.log( data.dept.deptId)
                }
            })
        });
    }

    /*选择部门树*/
    function selectDeptTree() {
        var treeId = $("#treeId").val();
        var deptId = $.common.isEmpty(treeId) ? "100" : $("#treeId").val();
        var url = ctx + "system/dept/selectDeptTree/" + deptId;
        var options = {
            title: '选择部门',
            width: "380",
            url: url,
            callBack: doSubmit
        };
        parent.$.modal.openOptions(options);
    }

    function doSubmit(index, layero) {
        var tree = layero.find("iframe")[0].contentWindow.$._tree;
        if ($.tree.notAllowParents(tree)) {
            var body = parent.layer.getChildFrame('body', index);
            $("#treeId").val(body.find('#treeId').val());
            $("#deptName").val(body.find('#treeName').val());
            parent.layer.close(index);
        } else {
            parent.$.modal.msgError("请选择非根节点以及父节点！");
        }
    }

    /*选择分组树*/
    function selectFzTree() {
        var url = prefix + "/selectFzTree";
        var options = {
            title: '选择分组',
            width: "450",
            url: url,
            callBack: doFzSubmit
        };
        parent.$.modal.openOptions(options);
    }
    function doFzSubmit(index, layero) {
        var tree = layero.find("iframe")[0].contentWindow.$._tree;
        var body = parent.layer.getChildFrame('body', index);
        $("#fzid").val(body.find('#fzid').val());
        $("#fzmc").val(body.find('#fzmc').val());
        parent.layer.close(index);
    }

</script>
</body>
</html>
