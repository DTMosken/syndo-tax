<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head>
	<th:block th:include="include :: layui-header('推送运行')" />
	<style type="text/css">
		.layui-body-table .layui-form .layui-form-item .layui-inline .layui-form-label {
			width:90px
		}
		.layui-body-table .layui-form .layui-form-item .layui-inline .layui-input-block {
			margin-left: 96px;
		}
		.layui-card-header{
			border-radius: 6px;
			box-shadow: 1px 1px 3px rgba(0 0 0 0.2);
			height: auto;
			padding:7px;
		}
		.layui-body-table, .layui-card {
			background-color: #f3f3f4;
		}
		.layui-table-tool, .layui-card-header {
			background-color: white;
		}
		.layui-body-table .layui-card-body {
			padding: 0;
			margin-top: 10px;
			border-radius: 6px;
			box-shadow: 1px 1px 3px rgba(0 0 0 0.2);
			background-color: white;
		}
		.layui-body-table .layui-table-view .layui-form-checked[lay-skin="toolbar"] i {
			border-color: #0a90ff !important;
			background-color: #0a90ff;
		}
		.layui-body-table .layui-table-view .layui-form-checkbox[lay-skin=toolbar] i {
			width: 15px;
			height: 15px;
			line-height: 14px;
			color: #fff;
			right: auto;
			left: 0;
			border: 1px solid #d2d2d2;
			font-size: 12px;
			border-radius: 2px;
			transition: .1s linear;
		}
		.layui-form-checkbox[lay-skin="toolbar"] {
			margin-left: 30px;
			height: auto!important;
			line-height: normal!important;
			min-width: 18px;
			min-height: 18px;
			border: none!important;
			margin-right: 0;
			padding-left: 20px;
			padding-right: 0;
			background: none;
		}
		.layui-form-checkbox[lay-skin="toolbar"] span {
			font-size: 12px;
			padding-left: 0;
			padding-right: 15px;
			line-height: 18px;
			background: none;
			color: #666;
		}
		xm-select > .xm-body .xm-option-content {
			font-size: 12px;
		}
		xm-select > .xm-body .xm-search {
			line-height: 36px;
		}
		xm-select > .xm-body .xm-option-content {
			padding-left: 5px !important;
		}
		
	</style>
</head>
<body class="layui-body-table">
     <div class="layui-card">
		<div class="layui-card-header">
			<form id="query-form" class="layui-form">
				<input type="hidden" id="presid" name="presid" value=""/>
				<input type="hidden" id="sid" name="sid" value=""/>
				<div class="layui-form-item layui-row layui-col-space12">
					<div class="layui-inline layui-col-sm3 layui-col-md3">
						<label class="layui-form-label">纳税人名称：</label>
						<div class="layui-input-block">
							<input type="text" id="nsrmc" name="nsrmc" value="" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline layui-col-sm3 layui-col-md3">
						<label class="layui-form-label">指标：</label>
						<div class="layui-input-block">
							<!--/*-->
							<select id="zbdm" name="zbdm" class="form-control input-sm" th:with="type=${@zbxx.getALlZbxx()}" lay-verify="" lay-search>
								<option value="">全部指标</option>
								<option th:each="dict : ${type}" th:text="${dict.zbmc}" th:value="${dict.zbdm}"></option>
							</select>
							<!--*/-->
							<div id="zbdms"></div>
						</div>
					</div>
					<div class="layui-inline layui-col-sm3 layui-col-md3">
						<div class="layui-form-btn" style="text-align: left" >
							<a class="layui-btn layui-btn-normal layui-btn-sm" onclick="getSid()">
								<i class="layui-icon">&#xe615;</i> 查询
							</a>
							
						</div>
					</div>
					<div class="layui-inline layui-col-sm12 layui-col-md12">
						<span style="margin-left: 20px; padding-top: 5px; color: blue;">注意：打开页面时不默认加载数据，请点击“查询”按钮查询指标数据</span>
					</div>
				</div>
			</form>
		</div>
		 <div class="layui-card-body">
			 <table id="layui-table" lay-filter="layui-table"></table>
		 </div>
	</div>
	<script type="text/html" id="zbTpl">
		<a href="javascript:;" onclick="zbinfo('{{d.zbdm}}','{{d.zbmc}}')" class="layui-table-link">{{ d.zbmc }}</a>
	</script>
	<script type="text/html" id="nsrTpl">
		<a href="javascript:;" onclick="ckmx('{{d.zbmc}}', '{{d.url}}', '{{d.nsrmc}}')" class="layui-table-link">{{ d.nsrmc }}</a>
	</script>
	<script type="text/html" id="tmpToolbar">
		<div class="layui-btn-container" id="toolbtn">
			<button class="layui-btn layui-bg-blue layui-btn-sm plfk" onclick="ts(1)">
			   推送选中
			</button>
			<button class="layui-btn layui-bg-blue layui-btn-sm plsh" onclick="ts(2)">
			   全部推送
			</button>
			<input type="checkbox" id="fs" title="同一纳税人推送给同一风控小组成员" value="1" lay-skin="toolbar" checked>
			<div style="position: absolute; background-color: white;top:-1px; left:-1px; width: calc(100% + 2px); height: 100%; z-index: -1;"></div>
		</div>
	</script>
    <th:block th:include="include :: layui-footer" />
    <script th:inline="javascript">
	var zbdmData = /*[[${@zbxx.getALlZbxx()}]]*/[];
	</script>
    <script th:inline="javascript">
        var prefix = ctx + "zhzs/dbfxxt/ts/tsyx";
		layui.use('xmSelect',function(){
			var xmSelect = layui.xmSelect;
			var zbdms = xmSelect.render({
				name: 'zbdms',
				el: '#zbdms',
				// style: {width:'100%'},
				theme: {
					color: '#1E9FFF'
				},
				filterable: true,
				toolbar: {
					show: false
				},
				model: {
					label: {
						type: 'block',
						block: {
							showCount: 2,
							showIcon: false
						}
					}
				},
				prop: {
					name: 'zbmc',
					value: 'zbdm',
				},
				data: zbdmData
			})
		});
        $(function() {
            var options = {
				id: 'layui-table',
				loadUrl: prefix + "/list",
				title: "推送运行",
				limit: 200,
				limits: [200],
				toolbar: '#tmpToolbar',
				ataType: "json",
				height: 'full-120',
				remoteSort: true,
				even: true,
				where: $.table.where('query-form'),
				bottomToolbar:[],
				cols: [
                	[
						{
							type:'checkbox'
						},
						{
							field : 'id',
							title : 'ID',
							align: 'center',
							hide: true
						},
						{
                        	field : 'nsrmc',
                            title : '纳税人名称',
                            align: 'left', 
							width: '250',
							sort: true,
							templet: '#nsrTpl'
                        },
                        {
                        	field : 'zbmc',
                            title : '指标',
                            align: 'left',
							width: '250',
							sort: true,
							templet: '#zbTpl'
                        },
						{
							field : 'fxms',
							title : '风险描述',
							align: 'left',
							width: '450'
						}
                    ]
                ]
            };
            $.table.init(options);
        });

		function getSid() {
			var url = prefix + "/getSid";
			$.operate.post(url, null, function(data) {
				var $sid = $('#sid');
				if($sid.val() != '') {
					$('#presid').val($sid.val());
				}
				$('#sid').val(data.data);
			});
		}

		function ts(lx) {
			var url = prefix + "/ts?sid="+ $('#sid').val() +"&lx="+ lx + "&fs="+(GetCheckboxValues('fs')||'0');
			var fkids=[];
			var confirmsg = "确认要全部推送吗？"
			if(lx == 1){
				fkids = $.table.selectColumns("id".toString());
				if (fkids.length === 0) {
					$.modal.alertWarning("请至少选择一行");
					return false;
				}
				confirmsg = "确认要推送选中行吗？"
			}
			$.modal.confirm(confirmsg, function() {
				$.modal.loading("正在处理中，请稍后...");
				$.post(url, {fkids: fkids.join(',')}, function(res){
					$.modal.closeLoading();
					if(res.code=='0') {
						$.modal.msgSuccess(res.msg, $.table.refresh());
					}else{
						$.modal.alertError(res.msg);
					}
				});
			});
		}

		function GetCheckboxValues(Name) {
			var result = [];
			$("[id='" + Name + "']:checkbox").each(function () {
				if ($(this).is(":checked")) {
					result.push($(this).attr("value"));
				}
			});
			return result.join(",");
		};
		function zbinfo(zbdm, zbmc) {
			var prefix1 = ctx + "zhzs/dbfxxt/ts/zbxx/info/";
			var width = 500;
			var height = 400;
			if (navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)) {
				width = 'auto';
			}
			parent.layer.open({
				area: [width + 'px', height + 'px'],
				type: 2,
				title: zbmc,
				btn: ['关闭'],
				shadeClose: true,
				content: prefix1 + zbdm
			});
		}
		function ckmx(zbmc, url, nsrmc){
			var prefix_ck = "//" + window.location.host;
			$.modal.openTab(zbmc, prefix_ck + url +"?nsrmc=" + nsrmc);
		}

    </script>
</body>
</html>