<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
	<th:block th:include="include :: header('新增指标规则库')" />
	<th:block th:include="include :: ztree-css-default" />
	<style type="text/css">
		.form-header {
		    margin: 0 100px 5px 0;
		    padding-bottom: 5px;
		}
		ul.ztree {margin-top: 10px;border: 1px solid #617775;background: #f0f6e4;width:220px;height:360px;overflow-y:scroll;overflow-x:auto;}
		.bootstrap-table .fixed-table-container .fixed-table-body table tbody tr td{
			white-space: normal;
		}
	</style>
</head>
<body class="white-bg">
	<div class="path-banner">
   		<span style="font-size:14px;"><span class="fa fa-chevron-right"></span>&nbsp;规则库管理 / 修改规则库</span>
   	</div>
	<div class="wrapper wrapper-content animated fadeInRight ibox-content" style="border-top:0">
		<form class="form-horizontal m" id="form-post-add" th:object="${model}">
			<input id="id" name="id" type="hidden" th:value="*{id}"/>		    
			<div class="form-group col-sm-6">
				<label class="col-sm-4 control-label is-required">规则名称：</label>
				<div class="col-sm-8">
					<input class="form-control" type="text" name="gzmc" id="gzmc" th:field="*{gzmc}" required>
				</div>
			</div>
			<div class="form-group col-sm-6">
				<label class="col-sm-4 control-label is-required">规则分类：</label>
				<div class="col-sm-8">
					<input type="hidden" name="flmlid" id="flmlid" th:value="*{flmlid}">
					<input class="form-control" type="text" name="flmc" id="flmc" th:field="*{flmc}" onclick="showMenu();" readonly="readonly" required>
				</div>
			</div>
			<div class="form-group col-sm-12" style="padding-left:10px">
				<label class="col-sm-2 control-label">规则说明：</label>
				<div class="col-sm-10">
					<textarea id="gzsm" name="gzsm" th:field="*{gzsm}" class="form-control"></textarea>
				</div>
			</div>
			<div class="row">
		        <div class="col-sm-12" style="text-align:center;">
		            <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler()"><span class="fa fa-check"></span>保 存</button>&nbsp;
		            <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><span class="fa fa-reply-all"></span>关 闭 </button>		            
		        </div>
		    </div>
		    <div class="row">
		    	<div class="btn-group-sm" id="toolbar" role="group">
		    		<span style="font-size:16px;margin-right:10px;"><span class="fa fa-navicon"></span>&nbsp;规则分组列表&nbsp;</span>
		        	<a class="btn btn-success" onclick="addFz()" >
		                <span class="fa fa-plus"></span> 新增
		            </a>
		             <a class="btn btn-primary single disabled" onclick="$.operate.editTab()" >
			            <span class="fa fa-edit"></span> 修改
			        </a>
		            <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()" >
		                <span class="fa fa-remove"></span> 删除
		            </a>		            
					<p style="color:red;padding-left:20px;line-height: 200%;">
						规则分组列表用企业规模、行业筛选企业属于哪个组，一个企业仅能匹配一个组，按从上往下顺序匹配<br/>
						注意：分组类型只有一个“其他”，并且分组类型“筛选条件”排在“其他”的前面
					</p>
		        </div>
			    <div class="col-sm-12 select-table table-striped">
				    <table id="bootstrap-table"></table>
				</div>
			</div>
		</form>
	</div>
	<div id="menuContent" class="menuContent" style="display:none; position: absolute;background-color: white;border:1px solid gray">
		<ul id="tree" class="ztree" style="margin-top:0; width:180px; height: 160px;"></ul>
	</div>
	<th:block th:include="include :: footer" />
	<th:block th:include="include :: ztree-js" />
	<script th:src="@{/main/js/sf-ui.extend.js?v=1.0.0}"></script>
	<script th:inline="javascript">
		var qygms = /*[[${@dict.getDict('dm_zb_qygm')}]]*/ null;
		var gzkfzlxs = /*[[${@dict.getDict('dm_zb_gzkfzlx')}]]*/ null;
	</script>
	<script type="text/javascript">
		var prefix = ctx + "module/industry/zbGzk";
			    
		$("#form-post-add").validate({
			onkeyup: false,
			rules:{
			},
			messages: {
		    },
		    focusCleanup: true
		});
		
		function submitHandler() {
	        if ($.validate.form()) {
	        	$.operate.saveTab(prefix + "/zbgzkEdit", $('#form-post-add').serialize(), function(){
	        		//alert('edit')
	        	}, false);
	        }
	    }
		
		function addFz() {
			table.set();
            $.modal.openTab("添加" + table.options.modalName, prefix + "/zbgzkfzAdd?gzid="+$('#id').val());
		}
		
		$(function() {
			queryTree();
			queryList();
			$(window).resize(function() {
				var cityObj = $("#flmc");
				var cityOffset = $("#flmc").offset();
				$("#menuContent").css({left:cityOffset.left + "px", top:cityOffset.top + cityObj.outerHeight() + "px"});
				$('#tree').width($('#flmc').width());
			});
		});
		function queryList() {
		    var options = {
		        url: prefix + "/zbgzkfzList?gzid=[[${model.id}]]",
		        updateUrl: prefix + "/zbgzkfzEdit/{id}",
		        removeUrl: prefix + "/zbgzkfzRemove",
	        	//sortName: "lrsj",
	        	//sortOrder: "desc",
		        modalName: "规则分组",
		        columns: [{
		            checkbox: true
		        },
		        {
		            field: 'fzid',
		            visible: false,
		            title: 'FZID'
		        },
		        {
		            field: 'fzmc',
		            title: '分组名称',
		            width: '120',
		            sortable: false
		        },
		        {
		            field: 'fzlx',
		            width: '100',
		            title: '分组类型',
		            sortable: false, 
		            align: 'center'
		            ,formatter: function(value, row, index) {
		            	return $.table.selectDictLabel(gzkfzlxs, value);
		            }
		        },
		        {
		            field: 'qygm',
		            width: '90',
		            title: '企业规模',
		            align: 'center'
		            ,formatter: function(value, row, index) {
		            	return $.table.selectDictLabel(qygms, value)||'-';
		            }
		        },
		        {
		            field: 'hymc',
		            title: '行业',
		            width: '140',
		            sortable: false,
		            align: 'left'
		            ,formatter: function(value, row, index) {
		            	return value?value.split('，').join('，<br>'):'-';
		            }
		        },
		        {
		            field: 'mf',
		            title: '省定、区县特色指标、加分项满分',
		            width: '150',
		            align: 'center',
		            sortable: false
		        },
		        {
		            title: '操作',
		            width: '190',
		            align: 'center',
		            formatter: function(value, row, index) {
		                var actions = [];
		                actions.push('<a class="btn btn-primary btn-xs" title="编辑" style="margin-right:10px" href="javascript:void(0)" onclick="$.operate.editTab(\'' + row.fzid + '\')"><span class="fa fa-edit"></span></a> ');
		                // actions.push('<a class="btn btn-info btn-xs" title="指标列表" style="margin-right:10px" href="javascript:void(0)" onclick="zblb(\'' + row.fzid + '\')"><span class="fa fa-list-ul"></span></a> ');
		                actions.push('<a class="btn btn-danger btn-xs" title="删除" style="margin-right:10px" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.fzid + '\')"><span class="fa fa-trash"></span></a> ');
		                actions.push('<a class="btn btn-default btn-xs'+(index+(table.options.pageNumber-1)*table.options.pageSize==0?' disabled':'')+'" title="上移" style="margin-right:10px" href="javascript:void(0)" onclick="up(\'' + row.fzid + '\')"><span class="fa fa-chevron-up"></span></a> ');
		                actions.push('<a class="btn btn-default btn-xs'+((table.options.pageNumber-1)*table.options.pageSize+index==table.options.totalRows-1?' disabled':'')+'" title="下移" href="javascript:void(0)" onclick="down(\'' + row.fzid + '\')"><span class="fa fa-chevron-down"></span></a> ');
		                return actions.join('');
		            }
		        }]
		    };
		    $.table.init(options);
		}
		
		function queryTree() {
			$('#tree').width($('#flmc').width());
			var url = prefix + "/treeData?lx=gzk";
			var options = {
		        url: url,
		        expandLevel: 2,
		        onClick : zOnClick,
		        view: {
					dblClickExpand: false
				},
				callback: {
					beforeClick: beforeClick
				}
		    };
			$.tree.init(options);
			
			function beforeClick(treeId, treeNode) {
				var check = (treeNode && !(treeNode.id=="100"));
				return check;
			}
			function zOnClick(event, treeId, treeNode) {
				var zTree = $.fn.zTree.getZTreeObj(treeId),
				    nodes = zTree.getSelectedNodes(),
				    label = "",
				    val="";
				nodes.sort(function compare(a,b){return a.id-b.id;});
				for (var i=0, l=nodes.length; i<l; i++) {
					label += nodes[i].name + ",";
					val += nodes[i].id + ",";
				}
				if (label.length > 0 ) label = label.substring(0, label.length-1);
				if (val.length > 0 ) val = val.substring(0, val.length-1);
				var cityObj = $("#flmc");
				cityObj.attr("value", label);
				$('#flmlid').val(val)
				hideMenu();
			}
		}
		function showMenu() {
			var cityObj = $("#flmc");
			var cityOffset = $("#flmc").offset();
			$("#menuContent").css({left:cityOffset.left + "px", top:cityOffset.top + cityObj.outerHeight() + "px"}).slideDown("fast");

			$("body").bind("mousedown", onBodyDown);
		}
		function hideMenu() {
			$("#menuContent").fadeOut("fast");
			$("body").unbind("mousedown", onBodyDown);
		}
		function onBodyDown(event) {
			if (!(event.target.id == "menuBtn" || event.target.id == "flmc" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {
				hideMenu();
			}
		}
		function up(fzid) {
			$.operate.post(prefix+"/zbgzkfzUp",{fzid:fzid});
		}
		function down(fzid) {
			$.operate.post(prefix+"/zbgzkfzDown",{fzid:fzid});
		}
		
	</script>
</body>
</html>
